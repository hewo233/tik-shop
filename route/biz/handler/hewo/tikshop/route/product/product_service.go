// Code generated by hertz generator.

package product

import (
	"context"
	"github.com/cloudwego/hertz/pkg/protocol/consts"
	"github.com/hewo/tik-shop/route/init/rpc"
	"github.com/hewo/tik-shop/route/utils"
	"github.com/jinzhu/copier"
	"net/http"

	"github.com/cloudwego/hertz/pkg/app"
	productrpc "github.com/hewo/tik-shop/kitex_gen/hewo/tikshop/product"
	base "github.com/hewo/tik-shop/route/biz/model/hewo/tikshop/route/base"
	product "github.com/hewo/tik-shop/route/biz/model/hewo/tikshop/route/product"
)

// CreateProduct .
// @Summary CreateProduct
// @Description 创建一个新的产品，包含产品的详细信息。
// @Tags product
// @Accept json
// @Produce json
// @Param request body product.CreateProductRequest true "Request body with product details"
// @Success 200 {object} product.CreateProductResponse "Product created successfully"
// @Failure 400 {string} string "Invalid request"
// @router /api/products [POST]
func CreateProduct(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.CreateProductRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(http.StatusBadRequest, product.CreateProductResponse{
			Base: &base.BaseResponse{
				Code:    40010,
				Message: err.Error(),
			},
		})
		return
	}

	rpcReq := productrpc.NewCreateProductRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(http.StatusBadRequest, product.CreateProductResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
		return
	}

	rpcResp, err := rpc.ProductClient.CreateProduct(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}
	resp := &product.CreateProductResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Created Product successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(http.StatusBadRequest, product.CreateProductResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
	}

	c.JSON(consts.StatusOK, resp)
}

// GetProductByID .
// @Summary GetProductByID
// @Description 根据产品 ID 获取单个产品的详细信息。
// @Tags product
// @Accept json
// @Produce json
// @Param id path string true "Product ID" // URL 路径参数
// @Param request query product.GetProductRequest true "Request params" // 查询参数
// @Success 200 {object} base.Product "Product details"
// @Failure 400 {string} string "Invalid request"
// @router /api/product/:id [GET]
func GetProductByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.GetProductByIDResponse
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(http.StatusBadRequest, product.GetProductByIDResponse{
			Base: &base.BaseResponse{
				Code:    40010,
				Message: err.Error(),
			},
		})
		return
	}

	// Everybody can Get

	rpcReq := productrpc.NewGetProductByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(http.StatusBadRequest, product.GetProductByIDResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
		return
	}

	rpcResp, err := rpc.ProductClient.GetProductByID(ctx, rpcReq)

	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.GetProductByIDResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Get Product successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(http.StatusBadRequest, product.GetProductByIDResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// ListProducts .
// @router /products [GET]
func ListProducts(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.ListProductsRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	rpcReq := productrpc.NewListProductsRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	rpcResp, err := rpc.ProductClient.ListProducts(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.ListProductsResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "List Products successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	c.JSON(consts.StatusOK, resp)
}

// UpdateProductByID .
// @router /product/:id [PUT]
func UpdateProductByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.UpdateProductByIDRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	merchantID, ok := NormalMerchantChecker(ctx, c, func(response *base.BaseResponse) *product.UpdateProductByIDResponse {
		return &product.UpdateProductByIDResponse{
			Base: response,
		}
	})
	if !ok {
		return
	}

	rpcReq := productrpc.NewUpdateProductByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	rpcReq.MerchantId = merchantID

	rpcResp, err := rpc.ProductClient.UpdateProductByID(ctx, rpcReq)

	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.UpdateProductByIDResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Update Product successfully",
		},
	}

	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// DeleteProductByID .
// @router /product/:id [DELETE]
func DeleteProductByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.DeleteProductByIDRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	merchantID, ok := NormalMerchantChecker(ctx, c, func(response *base.BaseResponse) *product.DeleteProductByIDResponse {
		return &product.DeleteProductByIDResponse{
			Base: response,
		}
	})
	if !ok {
		return
	}

	rpcReq := productrpc.NewDeleteProductByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	rpcReq.MerchantId = merchantID

	rpcResp, err := rpc.ProductClient.DeleteProductByID(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.DeleteProductByIDResponse{}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// ModifyStockByID .
// @router /product/:id/stock [PUT]
func ModifyStockByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.ModifyStockByIDRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	merchantID, ok := NormalMerchantChecker(ctx, c, func(response *base.BaseResponse) *product.ModifyStockByIDResponse {
		return &product.ModifyStockByIDResponse{
			Base: response,
		}
	})
	if !ok {
		return
	}

	rpcReq := productrpc.NewModifyStockByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	rpcReq.MerchantId = merchantID

	rpcResp, err := rpc.ProductClient.ModifyStock(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.ModifyStockByIDResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Modify Stock successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}
