// Code generated by hertz generator.

package product

import (
	"context"
	"github.com/cloudwego/hertz/pkg/protocol/consts"
	"github.com/hewo/tik-shop/route/init/rpc"
	"github.com/hewo/tik-shop/route/utils"
	"github.com/jinzhu/copier"
	"net/http"

	"github.com/cloudwego/hertz/pkg/app"
	productrpc "github.com/hewo/tik-shop/kitex_gen/hewo/tikshop/product"
	base "github.com/hewo/tik-shop/route/biz/model/hewo/tikshop/route/base"
	product "github.com/hewo/tik-shop/route/biz/model/hewo/tikshop/route/product"
)

// CreateProduct
// @Summary 创建商品
// @Description 创建一个新的商品,包含商品的详细信息
// @Tags 商品管理
// @Accept json
// @Produce json
// @Param request body product.CreateProductRequest true "创建商品请求参数"
// @Param Authorization header string true "Bearer token"
// @Success 200 {object} product.CreateProductResponse "Product created successfully"
// @Failure 400 {object} product.CreateProductResponse "Invalid request or validation failed"
// @Router /product [POST]
func CreateProduct(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.CreateProductRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(http.StatusBadRequest, product.CreateProductResponse{
			Base: &base.BaseResponse{
				Code:    40012,
				Message: err.Error(),
			},
		})
		return
	}

	merchantID, ok := NormalMerchantChecker(ctx, c, func(response *base.BaseResponse) *product.CreateProductResponse {
		return &product.CreateProductResponse{
			Base: response,
		}
	})
	if !ok {
		return
	}

	rpcReq := productrpc.NewCreateProductRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(http.StatusBadRequest, product.CreateProductResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
		return
	}
	rpcReq.MerchantId = merchantID

	rpcResp, err := rpc.ProductClient.CreateProduct(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}
	resp := &product.CreateProductResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Created Product successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(http.StatusBadRequest, product.CreateProductResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
	}

	c.JSON(consts.StatusOK, resp)
}

// GetProductByID
// @Summary 获取商品信息
// @Description 根据商品 ID 获取商品的详细信息
// @Tags 商品管理
// @Accept json
// @Produce json
// @Param id path int true "商品ID"
// @Success 200 {object} product.GetProductByIDResponse "Product details retrieved successfully"
// @Failure 400 {object} product.GetProductByIDResponse "Invalid request or product not found"
// @Router /product/{id} [GET]
func GetProductByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.GetProductByIDResponse
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(http.StatusBadRequest, product.GetProductByIDResponse{
			Base: &base.BaseResponse{
				Code:    40010,
				Message: err.Error(),
			},
		})
		return
	}

	// Everybody can Get

	rpcReq := productrpc.NewGetProductByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(http.StatusBadRequest, product.GetProductByIDResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
		return
	}

	rpcResp, err := rpc.ProductClient.GetProductByID(ctx, rpcReq)

	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.GetProductByIDResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Get Product successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(http.StatusBadRequest, product.GetProductByIDResponse{
			Base: &base.BaseResponse{
				Code:    40090,
				Message: err.Error(),
			},
		})
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// ListProducts
// @Summary 获取商品列表
// @Description 分页获取商品列表,支持按商家和状态筛选
// @Tags 商品管理
// @Accept json
// @Produce json
// @Param merchant_id query int true "商家ID" minimum(1)
// @Param status query int false "商品状态(0:全部,1:上架,2:下架)"
// @Param page query int true "页码" minimum(1)
// @Param page_size query int true "每页大小" minimum(1) maximum(100)
// @Success 200 {object} product.ListProductsResponse "Products retrieved successfully"
// @Failure 400 {object} product.ListProductsResponse "Invalid request"
// @Router /product/list [GET]
func ListProducts(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.ListProductsRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	rpcReq := productrpc.NewListProductsRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	rpcResp, err := rpc.ProductClient.ListProducts(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.ListProductsResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "List Products successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	c.JSON(consts.StatusOK, resp)
}

// UpdateProductByID
// @Summary 更新商品信息
// @Description 根据商品 ID 更新商品的基本信息(名称、描述、价格、状态)
// @Tags 商品管理
// @Accept json
// @Produce json
// @Param id path int true "商品ID"
// @Param request body product.UpdateProductByIDRequest true "更新商品请求参数"
// @Param Authorization header string true "Bearer token"
// @Success 200 {object} product.UpdateProductByIDResponse "Product updated successfully"
// @Failure 400 {object} product.UpdateProductByIDResponse "Invalid request or validation failed"
// @Router /product/{id} [PUT]
func UpdateProductByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.UpdateProductByIDRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	merchantID, ok := NormalMerchantChecker(ctx, c, func(response *base.BaseResponse) *product.UpdateProductByIDResponse {
		return &product.UpdateProductByIDResponse{
			Base: response,
		}
	})
	if !ok {
		return
	}

	rpcReq := productrpc.NewUpdateProductByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	rpcReq.MerchantId = merchantID

	rpcResp, err := rpc.ProductClient.UpdateProductByID(ctx, rpcReq)

	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.UpdateProductByIDResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Update Product successfully",
		},
	}

	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// DeleteProductByID
// @Summary 删除商品
// @Description 根据商品 ID 删除商品(软删除)
// @Tags 商品管理
// @Accept json
// @Produce json
// @Param id path int true "商品ID"
// @Param Authorization header string true "Bearer token"
// @Success 200 {object} product.DeleteProductByIDResponse "Product deleted successfully"
// @Failure 400 {object} product.DeleteProductByIDResponse "Invalid request"
// @Router /product/{id} [DELETE]
func DeleteProductByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.DeleteProductByIDRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	merchantID, ok := NormalMerchantChecker(ctx, c, func(response *base.BaseResponse) *product.DeleteProductByIDResponse {
		return &product.DeleteProductByIDResponse{
			Base: response,
		}
	})
	if !ok {
		return
	}

	rpcReq := productrpc.NewDeleteProductByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	rpcReq.MerchantId = merchantID

	rpcResp, err := rpc.ProductClient.DeleteProductByID(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.DeleteProductByIDResponse{}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}

// ModifyStockByID
// @Summary 修改商品库存
// @Description 根据商品 ID 增加或减少库存,支持乐观锁
// @Tags 商品管理
// @Accept json
// @Produce json
// @Param id path int true "商品ID"
// @Param request body product.ModifyStockByIDRequest true "修改库存请求参数"
// @Param Authorization header string true "Bearer token"
// @Success 200 {object} product.ModifyStockByIDResponse "Stock modified successfully"
// @Failure 400 {object} product.ModifyStockByIDResponse "Invalid request or insufficient stock"
// @Failure 409 {object} product.ModifyStockByIDResponse "Stock version conflict, please retry"
// @Router /product/{id}/stock [PUT]
func ModifyStockByID(ctx context.Context, c *app.RequestContext) {
	var err error
	var req product.ModifyStockByIDRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	merchantID, ok := NormalMerchantChecker(ctx, c, func(response *base.BaseResponse) *product.ModifyStockByIDResponse {
		return &product.ModifyStockByIDResponse{
			Base: response,
		}
	})
	if !ok {
		return
	}

	rpcReq := productrpc.NewModifyStockByIDRequest()
	if err = copier.Copy(rpcReq, &req); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}
	rpcReq.MerchantId = merchantID

	rpcResp, err := rpc.ProductClient.ModifyStockByID(ctx, rpcReq)
	if err != nil {
		utils.HandleRPCError(c, err)
		return
	}

	resp := &product.ModifyStockByIDResponse{
		Base: &base.BaseResponse{
			Code:    20000,
			Message: "Modify Stock successfully",
		},
	}
	if err = copier.Copy(resp, rpcResp); err != nil {
		c.JSON(consts.StatusBadRequest, err.Error())
		return
	}

	c.JSON(consts.StatusOK, resp)
}
